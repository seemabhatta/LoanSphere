# High-Level System Design — Co-Issue Loan Boarding (Demo)

> Goal: Turn co‑issue loan boarding bottlenecks (data/doc quality + manual exceptions) into a **high‑FPY, low‑latency, compliant** pipeline — implemented as a deterministic, local, demo‑ready multi‑agent system.

---

## 1. Architecture Overview

**Stack (local demo):** React (frontend) · FastAPI (Python backend) · OpenAI Agents SDK (Planner/Tool/Verifier agents) · SQLite (system state + canonical store) · TinyDB (config/fixtures) · RDFLib (in‑process knowledge graph) · Optional OpenSearch (text/semantic search) · File system/S3‑like paths for staged artifacts.

**Core components:**
- **Orchestrator (Coordinator)** — builds and executes a task DAG; enforces *no fallbacks*, hard timeouts, and explicit error surfacing.
- **Agents**
  - **PlannerAgent** — compiles “Board this package” into a DAG.
  - **ToolAgent** — runs whitelisted tools with strict JSON I/O contracts.
  - **VerifierAgent** — executes rule packs; gates commits; triggers rollbacks.
- **Ingestion Pipelines (Adapters)** — pluggable per agency for **Commitment**, **Purchase Advice**, **ULDD/Loan Data**, **Documents** (split/classify/extract), **Loan Tracking**.
- **Validation & Auto‑Fix** — rule packs (MISMO‑aligned) + deterministic fixers (format/normalization).
- **Exception Orchestrator & Analyst Workbench (stub)** — taxonomy, SLA timers, accept/reject auto‑fix with reason codes.
- **Boarding Services** — escrow recompute, staging/commit, compliance ledger (RESPA/TILA clocks), MSP/Sagent proxy payloads.
- **Observability** — command center, run/trace IDs, evidence drill‑through.

---

## 2. System Context & Interaction Model

```mermaid
flowchart LR
  UI[React UI]
  subgraph Backend (FastAPI)
    ORCH[Task Orchestrator]
    PLAN[PlannerAgent]
    TOOL[ToolAgent]
    VERIFY[VerifierAgent]
    EXC[Exception Orchestrator]
    PIPE[Ingestion Pipelines]
    DOC[Doc Processor]
    FIX[Auto‑Fixers]
    BOARD[Boarding Services]
  end
  DB[(SQLite)]
  TDB[(TinyDB Fixtures)]
  KG[(RDFLib KG)]
  FS[(Stage FS/S3‑like)]

  UI <--> ORCH
  ORCH --> PLAN --> ORCH
  ORCH --> PIPE --> FS
  ORCH --> DOC --> FS
  ORCH --> VERIFY --> DB
  ORCH --> FIX --> DB
  ORCH --> EXC --> UI
  ORCH --> BOARD --> DB
  PIPE <--> DB
  DOC <--> DB
  DB <--> KG
  ORCH <--> TDB
```

**Turn rules:** Planner → Tool(s) → Verifier → (Auto‑Fix → Verifier) → Exception/Analyst or Commit. *Retries off*. Any failure emits an error event with **trace_id** and remediation hint.

---

## 3. Data & Storage

### 3.1 Canonical Model (SQLite)
- **Loans** (by `xpLoanNumber`) · **Commitments** · **PurchaseAdvice** · **ULDD** · **Documents** · **Exceptions** · **Runs** · **Events** · **ComplianceLedger**.
- Provenance columns (source, file path, checksum), confidence scores for extracted fields, and *authoritative source* tagging (e.g., Note > ULDD for rate; Final CD > UCD for cash‑to‑close).

### 3.2 Fixtures & Staging
- **TinyDB** holds deterministic fixtures and agency/proxy configs.
- **Stage FS** mirrors S3‑like paths for raw/transformed artifacts (CSV/JSON/PDF) with versioning.

### 3.3 Knowledge Graph (RDFLib)
- Entities: Loan, Document, Party, Counterparty, Exception, Rule, County/FIPS.
- Relations: *hasDocument*, *violatesRule*, *belongsToCounterparty*, *duplicates*, *causedBy*.
- Uses for **root‑cause clustering**, **duplicate detection**, and **recurrence analysis**.

---

## 4. Pipelines (Adapter Pattern)

Each pipeline is a FastAPI tool with: **idempotent run**, **deterministic inputs**, **schema‑validated outputs**, and **evidence links**.

1) **Commitment Pipeline** — parses commitment fixture, persists canonical *Commitment*, links to loan by `xpLoanNumber`.

2) **Purchase Advice Pipeline** — ingests PA CSV/JSON, computes SRP & fees evidence, persists canonical *PurchaseAdvice*.

3) **Loan Data (ULDD) Pipeline** — ingests MISMO/ULDD JSON, normalizes selected fields (rate, UPB, escrow, identifiers), persists *ULDD* table.

4) **Documents Pipeline** — PDF ingest → split → classify → index → extract (OCR/LLM) → version/fingerprint; persists *Document* + extraction facts.

5) **Loan Tracking Pipeline** — maintains cross‑artifact links & readiness (`boardingReadiness`), with last‑evaluated timestamp.

**Adapter Contract (example):**
```json
{
  "run_id": "<uuid>",
  "pipeline": "purchase_advice",
  "inputs": {"path": "stage/purchaseAdvice/XP12345678.json"},
  "outputs": {"records": 1, "loan_keys": ["XP12345678"]},
  "evidence": {"raw": ".../raw/...", "transformed": ".../transformed/..."},
  "metrics": {"duration_ms": 842},
  "errors": []
}
```

---

## 5. Validation & Auto‑Fix

**Rule Packs (VerifierAgent):**
- **ULDD/UCD parity**: rate, amount, MI coverage.
- **Escrow integrity**: hazard/flood presence, cushions, due dates.
- **MERS/Assignment**: MIN format, registration, assignment chain.

**Auto‑Fixers (deterministic):** SSN formatter, date harmonizer, county/FIPS normalizer, rate precision normalizer. Fixes require *confidence ≥ threshold* and are logged for override analytics.

**Outcome Schema:**
```json
{
  "run_id": "<uuid>",
  "loan": "XP12345678",
  "rule_id": "ESCROW_DUE_DATE_PRESENT",
  "status": "VIOLATION",
  "evidence": {"source": "ULDD#path", "field": "EscrowItems"},
  "proposed_fix": {"action": "SET_DEFAULT_DUE_DATE", "value": "2025-07-01"},
  "confidence": 0.94
}
```

---

## 6. Exception Orchestrator & Analyst Workbench (Stub)

- **Taxonomy**: DataMismatch, MissingDoc, VersionConflict, EscrowDefect, IdentifierError, ComplianceClockRisk…
- **SLA Timers**: queue‑level + exception‑level; breach events visible in Command Center.
- **Analyst Actions**: accept/reject fix, apply reason code, escalate, bulk ops.
- **UX Stub**: React screens that list exceptions with evidence, confidence, and one‑click actions; all actions create immutable logs for ML v2.

---

## 7. Boarding & Compliance

- **Escrow Setup Service**: recompute impounds; validate county/FIPS; ready payload for MSP/Sagent proxy.
- **Boarding Orchestration**: stage → commit with dual‑control; rollback path on Verifier gate failure.
- **Compliance Ledger**: immutable WORM‑style append‑only records for RESPA/TILA timers (welcome letters, escrow setup). Breaches emit explicit events; no silent retries.

---

## 8. Observability & Determinism

- **Run & Trace IDs** on every agent/tool step; consistent hashing over inputs guarantees deterministic behavior.
- **Command Center**: FPY, TTB, auto‑clear %, recurrence, analyst actions, counterparty scorecards; drill‑through into evidence.
- **Event Log**: structured events per state transition (Created → Running → Succeeded/Failed).

---

## 9. Security & Governance (Demo‑appropriate)

- PII masking/tokenization for SSN/ACH in logs and stores.
- RBAC views in UI (Seller vs Buyer vs Analyst vs Regulator).
- Versioned schema governance; proxy contracts validated in CI.

---

## 10. Message & DB Schemas (Essentials)

**Task Message (Planner → Orchestrator):**
```json
{"task_id":"<uuid>","intent":"BOARD_PACKAGE","loan":"XP12345678","constraints":{"no_fallbacks":true,"timeout_s":30}}
```

**Tool I/O Envelope:**
```json
{"run_id":"<uuid>","tool":"uldd_ingest","inputs":{...},"outputs":{...},"errors":[],"evidence":{...}}
```

**SQLite tables (minimal):**
- `loans(xp_loan_number PK, status, readiness, last_evaluated_ts, provenance, ...)`
- `commitments(id PK, xp_loan_number FK, min_ptr, status, source_path, ...)`
- `purchase_advice(id PK, xp_loan_number FK, rate, pass_thru_rate, srp_net, fees, escrow_balance, ...)`
- `uldd(id PK, xp_loan_number FK, note_rate, upb, escrow_items_json, mers_min, identifiers_json, ...)`
- `documents(id PK, xp_loan_number FK, type, path, version, fingerprint, extracted_json, ...)`
- `exceptions(id PK, xp_loan_number, rule_id, status, proposed_fix_json, confidence, sla_due_ts, ...)`
- `runs(id PK, task, started_ts, ended_ts, status, trace_id, metrics_json)`
- `events(id PK, run_id, type, payload_json, ts)`
- `compliance_ledger(id PK, xp_loan_number, clock, due_ts, satisfied_ts, status)`

---

## 11. Proxies & External Contracts

- **Agency APIs (Proxied)**: endpoints mirror real contracts; served by FastAPI with deterministic fixtures (record–replay or static JSON/CSV).
  - `GET /agency/{name}/commitments/{id}` → commitment JSON
  - `GET /agency/{name}/purchase-advice/{id}` → CSV/JSON
  - `GET /agency/{name}/loan-data/{id}` → MISMO/ULDD JSON
  - `GET /agency/{name}/documents/{id}` → PDF blob
- **Servicing Systems (Proxied)**: `POST /servicer/{name}/board` → echoes payload, emits tracking event.
- **Error Catalog**: every proxy has fixed error modes (timeouts, schema mismatch, 4xx contract errors) to exercise guardrails.

---

## 12. End‑to‑End Demo Flow (Deterministic Scenario)

1) **Stage** sample package (commitment, purchase advice, ULDD, PDFs) and link by `xpLoanNumber`.
2) **Scheduler** dispatches Ingestion Pipelines → canonical tables + evidence paths.
3) **Doc Processor** splits/classifies/indexes PDFs; extraction facts persisted with confidence.
4) **Verifier** runs rule packs; violations propose **Auto‑Fix**; accepted fixes re‑validate.
5) **Exceptions** unresolved → Analyst Workbench; accepted fixes → **Boarding**.
6) **Boarding** commits with dual‑control; **Compliance Ledger** clocks start; events visible in Command Center.

**Success metrics (demo):** FPY↑, TTB↓, Auto‑clear%↑, Recurrence↓, Analyst NPS↑.

---

## 13. Guardrails & Non‑Goals

- **No fallback mechanisms**: single model/tool path; no silent retries.
- **Hard timeouts** per call; explicit error surfacing with trace IDs.
- **Local‑only** data plane for demo (SQLite/TinyDB/RDFLib/OpenSearch optional docker).
- **Out of scope**: real vendor integrations, production‑grade security, multi‑tenant scaling.

---

## 14. Open Questions / Next Steps

- Finalize authoritative source matrix per field.
- Calibrate confidence thresholds for Auto‑Fix.
- Select top 10 exception rules for v1 demo and map to UX stub.
- Add regulator view (read‑only) into Command Center.

---

### Appendix A — Example Field Mappings (from fixtures)

- **Linkage key**: `xpLoanNumber` present across **loan tracking**, **purchase advice**, **documents**, **ULDD**.
- **Purchase Advice → Canonical**: `interestRate`, `passThruRate`, `grossSrp`, `netSrp`, `escrowBalance`, `lpiDate`, `firstDueDate`.
- **ULDD → Canonical**: `NoteRatePercent`, `UPBAmount`, `EscrowItems`, `MERS_MIN`, `Identifiers`, `LoanMaturity`, `PaymentRule`.
- **Documents**: `{xpDocId, documentType, path}` + classification status; extracted facts (appraisal value/effective date, etc.).

---

*This document defines the demo‑ready blueprint. The low‑level plan will specify repo layout, Pydantic models, FastAPI routes, agent prompts, rule packs, proxy fixtures, tests, and CLI scenarios.*


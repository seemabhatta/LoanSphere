# Low-Level Implementation Plan — Co-Issue Loan Boarding (Demo)

> Deterministic, local, no-fallback demo built with **React + FastAPI + OpenAI Agents SDK + SQLite**. Uses **TinyDB** for fixtures (document NoSQL), **RDFLib** as in-process knowledge graph, optional **OpenSearch** for full‑text. All failures surface explicitly with trace IDs.

---

## 1) Environment Setup

**Python**: 3.11+

**Create venv & install**
```bash
python -m venv .venv && source .venv/bin/activate
pip install -U pip
pip install fastapi uvicorn[standard] pydantic==2.* sqlalchemy aiosqlite alembic \
            python-dotenv loguru orjson httpx tenacity \
            rdflib tinydb \
            openai openai-agents-sdk  # placeholder; wire to actual package name
# optional
pip install opensearch-py pdfminer.six pypdf pillow pytesseract
```

**Node (UI)**: 20+
```bash
npm create vite@latest ui -- --template react-ts
cd ui && npm i && npm i axios recharts framer-motion zustand
```

**.env (backend)**
```
OPENAI_API_KEY=sk-...
DB_URL=sqlite+aiosqlite:///./var/app.db
FIXTURE_DIR=./fixtures
NO_FALLBACKS=true
REQUEST_TIMEOUT_SECONDS=30
ENABLE_OPENSEARCH=false
```

Repo layout:
```
coissue-demo/
  backend/
    app/
      __init__.py
      main.py
      config.py
      db/ (SQLAlchemy + Alembic)
        base.py
        models.py
        schema.sql
        migrations/
      agents/
        orchestrator.py
        planner_agent.py
        tool_agent.py
        verifier_agent.py
        tools/
          commitments.py
          purchase_advice.py
          uldd.py
          documents.py
          loan_tracking.py
          escrow.py
      pipelines/
        run_commitment.py
        run_purchase_advice.py
        run_uldd.py
        run_documents.py
        run_tracking.py
      proxies/
        agency.py
        servicer.py
        error_catalog.py
      services/
        validation.py
        autofix.py
        compliance.py
        graph.py
      observability/
        logging.py
        events.py
      api/
        routes_orchestrator.py
        routes_pipelines.py
        routes_proxies.py
        routes_readonly.py
      tests/
        test_pipelines.py
        test_rules.py
        test_proxies.py
        test_determinism.py
    fixtures/
      ideas_v3.md
      commitment.json
      purchase_advice.json
      uldd.json
      documents.json
      loan_tracking.json
      scenario_coissue.yaml
  ui/
    src/
      ...
  run_demo.py
```

---

## 2) Database (SQLite) — DDL

> Canonical, minimal schema with provenance, confidence, and evidence links. Deterministic constraints + indexes.

```sql
-- loans
CREATE TABLE IF NOT EXISTS loans (
  xp_loan_number TEXT PRIMARY KEY,
  tenant_id TEXT,
  status TEXT CHECK(status IN ('Staged','ReadyToBoard','Boarded','Failed')) DEFAULT 'Staged',
  readiness TEXT,
  last_evaluated_ts TEXT,
  provenance_json TEXT,          -- e.g., source paths + checksums
  authoritative_source_json TEXT, -- field->source map
  created_ts TEXT DEFAULT (datetime('now')),
  updated_ts TEXT DEFAULT (datetime('now'))
);

-- commitments
CREATE TABLE IF NOT EXISTS commitments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  commitment_id TEXT,
  seller_number TEXT,
  servicer_number TEXT,
  status TEXT,
  min_ptr REAL,
  product TEXT,
  commitment_date TEXT,
  expiration_date TEXT,
  remaining_balance REAL,
  srp_grid_id TEXT,
  raw_path TEXT,
  transformed_path TEXT,
  checksum TEXT
);
CREATE INDEX IF NOT EXISTS idx_commitments_loan ON commitments(xp_loan_number);

-- purchase_advice
CREATE TABLE IF NOT EXISTS purchase_advice (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  interest_rate REAL,
  pass_thru_rate REAL,
  gross_srp REAL,
  srp_holdback REAL,
  servicer_fees REAL,
  net_srp REAL,
  escrow_balance REAL,
  first_due_date TEXT,
  lpi_date TEXT,
  remittance_type TEXT,
  city TEXT, state TEXT, zip TEXT,
  raw_path TEXT, transformed_path TEXT, checksum TEXT
);
CREATE INDEX IF NOT EXISTS idx_pa_loan ON purchase_advice(xp_loan_number);

-- uldd (subset)
CREATE TABLE IF NOT EXISTS uldd (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  note_rate_percent REAL,
  upb_amount REAL,
  escrow_items_json TEXT,
  mers_min TEXT,
  identifiers_json TEXT,
  loan_maturity_date TEXT,
  payment_rule_json TEXT,
  servicing_json TEXT,
  raw_path TEXT, transformed_path TEXT, checksum TEXT
);
CREATE INDEX IF NOT EXISTS idx_uldd_loan ON uldd(xp_loan_number);

-- documents
CREATE TABLE IF NOT EXISTS documents (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  doc_guid TEXT,
  doc_id TEXT,
  document_type TEXT,
  path TEXT,
  classified INTEGER,
  fingerprint TEXT,
  extracted_json TEXT,
  version INTEGER DEFAULT 1,
  checksum TEXT
);
CREATE INDEX IF NOT EXISTS idx_docs_loan ON documents(xp_loan_number);

-- exceptions
CREATE TABLE IF NOT EXISTS exceptions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  rule_id TEXT,
  status TEXT CHECK(status IN('OPEN','ACK','RESOLVED','REJECTED')) DEFAULT 'OPEN',
  taxonomy TEXT,
  proposed_fix_json TEXT,
  confidence REAL,
  evidence_json TEXT,
  sla_due_ts TEXT,
  created_ts TEXT DEFAULT (datetime('now')),
  updated_ts TEXT DEFAULT (datetime('now'))
);
CREATE INDEX IF NOT EXISTS idx_ex_loan ON exceptions(xp_loan_number);

-- runs & events
CREATE TABLE IF NOT EXISTS runs (
  id TEXT PRIMARY KEY, -- uuid
  task TEXT,
  status TEXT CHECK(status IN('Created','Running','Succeeded','Failed')),
  trace_id TEXT,
  started_ts TEXT,
  ended_ts TEXT,
  metrics_json TEXT
);
CREATE TABLE IF NOT EXISTS events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  run_id TEXT REFERENCES runs(id) ON DELETE CASCADE,
  type TEXT,
  payload_json TEXT,
  ts TEXT DEFAULT (datetime('now'))
);

-- compliance ledger
CREATE TABLE IF NOT EXISTS compliance_ledger (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  xp_loan_number TEXT REFERENCES loans(xp_loan_number) ON DELETE CASCADE,
  clock TEXT, -- e.g., WelcomeLetter, EscrowSetup
  due_ts TEXT,
  satisfied_ts TEXT,
  status TEXT CHECK(status IN('PENDING','SATISFIED','BREACHED')) DEFAULT 'PENDING'
);
```

**Seed loader:** parse provided JSON fixtures in `/mnt/data` into canonical tables (see §6).

---

## 3) Message Contracts (Pydantic)

```python
from pydantic import BaseModel, Field
from typing import Any, Dict, List, Optional

class ToolEnvelope(BaseModel):
    run_id: str
    tool: str
    inputs: Dict[str, Any]
    outputs: Dict[str, Any] | None = None
    evidence: Dict[str, Any] | None = None
    errors: List[Dict[str, Any]] = []

class TaskMessage(BaseModel):
    task_id: str
    intent: str  # e.g., BOARD_PACKAGE
    loan: str
    constraints: Dict[str, Any] = {"no_fallbacks": True, "timeout_s": 30}
```

**Validation Outcome**
```python
class RuleOutcome(BaseModel):
    run_id: str
    loan: str
    rule_id: str
    status: str  # VIOLATION | PASS
    evidence: Dict[str, Any]
    proposed_fix: Optional[Dict[str, Any]]
    confidence: float
```

---

## 4) Agents & Orchestrator Wiring

**PlannerAgent**: translates `BOARD_PACKAGE(xpLoanNumber)` → ordered steps: ingest_commitment → ingest_pa → ingest_uldd → ingest_docs → evaluate_rules → apply_autofix → revalidate → board.

**ToolAgent**: executes any `pipelines/*.py` function exposed with signature `def run(inputs: dict, ctx: RunCtx) -> ToolEnvelope` where `RunCtx(trace_id, db, fs, cfg)`.

**VerifierAgent**: evaluates rule packs and returns `RuleOutcome[]`. If any `VIOLATION` without acceptable `proposed_fix`, the Orchestrator halts and opens exceptions.

**No fallbacks**: Orchestrator never retries a failed step. It records an `events` row with a canonical error code + remediation hint.

**Sketch**
```python
# app/agents/orchestrator.py
async def board_package(xp_loan_number: str) -> str:
    run = Runs.start(task="BOARD_PACKAGE")
    try:
        await Pipelines.commitment.run({"loan": xp_loan_number}, run.ctx)
        await Pipelines.purchase_advice.run({"loan": xp_loan_number}, run.ctx)
        await Pipelines.uldd.run({"loan": xp_loan_number}, run.ctx)
        await Pipelines.documents.run({"loan": xp_loan_number}, run.ctx)
        outcomes = await Verifier.evaluate(xp_loan_number, run.ctx)
        fixed = await AutoFix.apply(outcomes, run.ctx)
        if fixed:
            outcomes = await Verifier.evaluate(xp_loan_number, run.ctx)
        Gate.ensure_clean(outcomes)  # raises on violation
        await Boarding.commit(xp_loan_number, run.ctx)
        Runs.finish(run, status="Succeeded")
    except Exception as e:
        Runs.fail(run, exc=e)
        raise
    return run.id
```

---

## 5) FastAPI — Routes

```python
# app/api/routes_orchestrator.py
@router.post("/orchestrator/board/{xp_loan_number}")
async def board(xp_loan_number: str):
    run_id = await orchestrator.board_package(xp_loan_number)
    return {"run_id": run_id}

# app/api/routes_pipelines.py
@router.post("/pipelines/{name}/run")
async def run_pipeline(name: str, inputs: dict):
    return await PIPELINE_REGISTRY[name].run(inputs, ctx())

# app/api/routes_proxies.py
@router.get("/agency/{name}/commitments/{id}")
async def agency_commitment(name: str, id: str):
    return Proxies.agency.get_commitment(name, id)

@router.post("/servicer/{name}/board")
async def board_servicer(name: str, payload: dict):
    return Proxies.servicer.board(name, payload)

# read-only for UI
@router.get("/loans/{xp}/exceptions")
async def list_exceptions(xp: str):
    return Queries.exceptions_for(xp)
```

---

## 6) Pipelines (Adapters) — Deterministic I/O

**Shared inputs**: `{ "loan": "XP12345678" }`

**Commitment** (`/mnt/data/commitment_*.json`) → `commitments`
```python
def run(inputs, ctx):
    loan = inputs["loan"]
    src = Path("/mnt/data/commitment_1756041797769.json")
    data = orjson.loads(src.read_bytes())
    row = map_commitment(loan, data)
    db.insert_commitment(row, provenance(src))
    return envelope(ctx.run_id, "commitment", inputs, outputs={"records":1})
```

**Purchase Advice** (`purchaseAdvice_*.json`) → `purchase_advice`
- map: `interestRate → interest_rate`, `passThruRate → pass_thru_rate`, SRP fields, escrow.

**ULDD/Loan Data** (`loan-data_*.json`) → `uldd`
- map: `TERMS_OF_MORTGAGE.NoteRatePercent`, `PAYMENT.PAYMENT_SUMMARY.UPBAmount`, `ESCROW.ESCROW_ITEMS` as JSON array, `MERS_MINIdentifier`.

**Documents** (`documents_*.json`) → `documents`
- fingerprint: `sha256(path + size)`; mark `classified`.

**Loan Tracking** (`loan-tracking_*.json`) → `loans`
- set `status.readiness` and `lastEvaluated`.

**Canonical Mappers (examples)**
```python
def map_purchase_advice(xp, pa):
    return dict(
        xp_loan_number=xp,
        interest_rate=pa["interestRate"],
        pass_thru_rate=pa["passThruRate"],
        gross_srp=pa["grossSrp"],
        srp_holdback=pa["srpHoldback"],
        servicer_fees=pa["servicerFees"],
        net_srp=pa["netSrp"],
        escrow_balance=pa["escrowBalance"],
        first_due_date=pa["firstDueDate"],
        lpi_date=pa["lpiDate"],
        remittance_type=pa["remittanceType"],
        city=pa["city"], state=pa["state"], zip=pa["zip"]
    )
```

---

## 7) Rule Packs & Auto‑Fixers

**Rules (VerifierAgent)**
- `RATE_PARITY`: `purchase_advice.interest_rate == uldd.note_rate_percent`
- `ESCROW_ITEMS_PRESENT`: `len(uldd.escrow_items_json) > 0`
- `MERS_MIN_FORMAT`: regex for 18‑digit or 19‑digit with checksum

**Auto‑Fixers (deterministic)**
- `normalize_rate_precision`: round to 3–5 decimals.
- `date_harmonizer`: `mm/dd/yyyy` ↔ ISO‐8601.
- `fips_normalizer`: lookup from TinyDB fixture for county/state.
- `ssn_masker`: redact logs; never writes to canonical tables.

**Outcome gating**
```python
violations = [o for o in outcomes if o.status=="VIOLATION" and not o.proposed_fix]
if violations:
    ExceptionOrchestrator.open(violations)
    raise GateError("Verifier gate failed", trace_id=ctx.trace_id)
```

---

## 8) Proxies (Deterministic Stubs)

**Agency API** (record–replay via fixtures)
- `GET /agency/{name}/commitments/{id}` → loads `fixtures/agency/{name}/commitments/{id}.json`
- `GET /agency/{name}/purchase-advice/{id}` → `.../pa/{id}.json`
- **Errors**: `429 TooManyRequests`, `408 Timeout`, `422 ContractMismatch` (static payloads from `error_catalog.py`).

**Servicer API**
- `POST /servicer/{name}/board` → echoes payload with `board_id`, updates `compliance_ledger` clocks.

**Error Catalog** (examples)
```json
{"code":"AGENCY_TIMEOUT","http":408,"hint":"Reduce page size or retry later (disabled in demo)"}
{"code":"SCHEMA_MISMATCH","http":422,"hint":"Check agency contract snapshot version"}
```

---

## 9) Knowledge Graph (RDFLib)

Build triples on ingest:
```
Loan(XP12345678) --hasDocument--> Document(Appraisal)
Loan(XP12345678) --hasPA--> PA(2025-05-12)
Document(Appraisal) --extractedValue--> (PropertyValuationAmount, 295000)
Exception(E1) --violatesRule--> RATE_PARITY
Loan(XP12345678) --belongsToCounterparty--> Seller( Royal United Mortgage LLC )
```
Queries: cluster by `violatesRule`, summarize recurrence by counterparty; expose counts in Command Center.

---

## 10) Observability

**Run/Trace IDs**: `run_id = uuid4()`, `trace_id = sha1(str(inputs) + checksum(raw)).hexdigest()`

**Event Model**: `events(run_id, type, payload_json)` with types: `PIPELINE_START`, `PIPELINE_END`, `RULES_EVALUATED`, `AUTOFIX_APPLIED`, `EXCEPTION_OPENED`, `BOARDING_COMMIT`, `ERROR`.

**Logging**: JSON lines (orjson) with `trace_id`, `run_id`, `step`, `latency_ms`, `status`.

---

## 11) CLI & Scenarios

`run_demo.py`
```bash
python run_demo.py --scenario scenario_coissue.yaml
```

**scenario_coissue.yaml**
```yaml
loans:
  - xp: XP12345678
    ingest:
      commitment: /mnt/data/commitment_1756041797769.json
      purchase_advice: /mnt/data/purchaseAdvice_1756041797772.json
      uldd: /mnt/data/loan-data_1756041797771.json
      documents: /mnt/data/documents_1756041797770.json
      tracking: /mnt/data/loan-tracking_1756041797771.json
    board: true
```

---

## 12) UI (React) — Analyst Workbench Stub

- **Exceptions Table**: columns (Rule, Taxonomy, Confidence, SLA Due, Actions)
- **Evidence Drawer**: render JSON evidence, raw/transformed paths, checksums.
- **Action Buttons**: Accept Fix / Reject Fix / Escalate → POST to backend (write immutable log only).
- **Command Center**: FPY, TTB, Auto‑clear %, Recurrence clusters (from KG), Counterparty scorecards.

State: lightweight store via **Zustand**. API via Axios. All read‑only except exception actions.

---

## 13) Tests

**Determinism**
- Same fixtures → same DB state hash (hash of SELECT * from canonical tables ordered).

**Pipelines**
- Each pipeline with happy path + error modes (`SCHEMA_MISMATCH`, `TIMEOUT`, `BAD_PATH`).

**Rules**
- Unit tests for `RATE_PARITY`, `ESCROW_ITEMS_PRESENT`, `MERS_MIN_FORMAT`.

**Proxies**
- Contract tests: response JSON matches snapshot schemas.

**End‑to‑End**
- Scenario run results in **Boarded** when fixtures are clean; **Exceptions** when injected defects are present.

---

## 14) Security & Config

- PII masking in logs (`***-**-****`).
- RBAC roles in UI (Seller/Buyer/Analyst/Regulator) — feature flags only.
- .env toggles: `ENABLE_OPENSEARCH`, `ENABLE_KG`.

---

## 15) Done/Exit Criteria

- `run_demo.py` produces a complete run with surfaced metrics, or fails with explicit error + trace ID.
- Swapping proxy ↔ real service is a **config-only** change.
- Deterministic re-run hash matches across runs.

---

### Appendix A — Field Mapping from Provided Fixtures

- **Linkage Key:** `xpLoanNumber` present across *loan_tracking*, *purchase_advice*, *documents*, *ULDD*.
- **Purchase Advice → canonical**: `interestRate`, `passThruRate`, `grossSrp`, `netSrp`, `escrowBalance`, `firstDueDate`, `lpiDate`, `remittanceType`, `city/state/zip`.
- **ULDD → canonical**: `TERMS_OF_MORTGAGE.NoteRatePercent`, `PAYMENT.PAYMENT_SUMMARY.UPBAmount`, `ESCROW.ESCROW_ITEMS[*]`, `LOAN_IDENTIFIERS.MERS_MINIdentifier`.
- **Documents → canonical**: `{xpDocGUID, xpDocId, documentType, links.location}` as `path`, `status.classified`.

### Appendix B — Error Codes (excerpt)

- `AGENCY_TIMEOUT(408)` — hint: *retry disabled; verify agency availability*
- `SCHEMA_MISMATCH(422)` — hint: *check snapshot contract version*
- `VERIFIER_GATE_FAIL(409)` — hint: *open exceptions and resolve before commit*
- `COMPLIANCE_BREACH(424)` — hint: *manually acknowledge breach in ledger*

